<body>
  <a href='#' onclick='listConnections("20m")'>List Connections 20m</a>
  <a href='#' onclick='listCallSquares()'>List call squares</a>
  
</body>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<script>
  const squaresArr=["IO90","IO91","IO92"];

  const callSquares = {};
  const connections = {};

  mqttClient=mqtt.connect("wss://mqtt.pskreporter.info:1886");
  mqttClient.onSuccess=subscribe();
  mqttClient.on("message", (filter,message) => {onMessage(message.toString());}  );
  
  function subscribe(){
    //pskr/filter/v2/{band}/{mode}/{sendercall}/{receivercall}/
    //{senderlocator}/{receiverlocator}/{sendercountry}/{receivercountry}
    squaresArr.forEach((sq) => {
      var topic='pskr/filter/v2/+/+/+/+/'+sq+'/+/+/#';
      console.log("Subscribe to "+topic);
      mqttClient.subscribe(topic, (error) => {if (error) {
              console.error('subscription failed to '+topic, error)}});
      var topic='pskr/filter/v2/+/+/+/+/+/'+sq+'/+/#';
      console.log("Subscribe to "+topic);
      mqttClient.subscribe(topic, (error) => {if (error) {
              console.error('subscription failed to '+topic, error)}});
    } );
  }
  
  function onMessage(msg){
    // sq - sequence number f - frequency md - mode rp - report (snr) t - seconds since 1970-01-01
    // sc/rc - sender call / receiver call
    // sl/rl - sender locator / receiver locator
    // sa / ra - sender ADIF country code / receiver ADIF country code
    // b - band
    
    
    const conn={band:getVal("b",msg), mode:getVal("md",msg)}
    if (squareIsInHome(getVal("sl",msg))) {
       conn["HomeCall"]=getVal("sc",msg);
       conn["ConnectedCall"]=getVal("sl",msg);
    } else {
       conn["HomeCall"]=getVal("rc",msg);
       conn["ConnectedCall"]=getVal("rl",msg);
    }
    if ([getVal("sq",msg)] in connections) console.log("SQ is not unique");
   
    connections[getVal("sq",msg)]=conn;
   
//    if ([getVal("sq",msg)] in connections) console.log("SQ added successfully");
   
    callSquares[getVal("sc",msg)]= getVal("sl",msg);
    callSquares[getVal("rc",msg)]= getVal("rl",msg);

   
  }
  
  
  function listConnections(band){
  // list the whole object with structure
//   for (const [id, conn] of Object.entries(connections)) {
//      console.log(conn);
//   }
  // list line by line
   for (const [id, conn] of Object.entries(connections)) {
      console.log(`Band:${conn['band']} Mode:${conn['mode']} Home Call:${conn['HomeCall']} Connected Call:${conn['ConnectedCall']}`);
   }
  }
  
  function listCallSquares(){
 for (const [call, square] of Object.entries(callSquares)) {
    console.log(`${call}: ${square}`);
}
  //   for (const [call,square] of Object.entries(callSquares)) { console.log({call},{square});  }; 
  }
 
  
  function squareIsInHome(sq){
    // return true if the level 4, 6, 8 or 10 square sq is in the home squares array
    return (squaresArr.includes(sq.substring(0,4)) || squaresArr.includes(sq.substring(0,6)) || squaresArr.includes(sq.substring(0,8)) || squaresArr.includes(sq.substring(0,10)));
  }
  
  function getVal(key,message){
    // parse the MQTT message to get the part we want (key)
    var iVal=message.indexOf('"'+key+'":');
    var iColon=message.indexOf(':',iVal);
    var iComma=message.indexOf(",",iColon);
    var val=message.slice(iColon+1,iComma).replace(/"/g, '');
    return val;
  }
  
  
</script>
