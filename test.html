<!-- To do:

  Add tickbox to control inclusion of squares with callsigns and/or make the square bit smaller
  
  Underline squares in main list spotted / reached by me
-->

<html>
<head><style>

:root {background-color: #91FCFE; color:black;text-align: left; font-size: 1.3vmax;}
div {margin: 2px;  padding: 5px;}
#BO_title {text-align: center; font-size: 5rem;}
#BO_subtitle {text-align: center; font-size: 1.5rem;}
.detail > div {background-color: white;}
.transmit {color:red; }
.receive {color:green; }
.interzone {color:blue; }
.outgoing {color:Fuchsia; }
.incoming {color:olive;}
.bandblock {display: grid; grid-template-columns: auto auto auto auto auto;}
.bandblock > div {background-color: white;}
.creditsblock {color:black; font-size: 0.7rem; display: grid; grid-template-columns: auto auto auto;}
</style>
</head>

<body id="BandOpticonBody"><div>
<div id="BO_title" name="BO_title">BandOpticon</div>
<div id="BO_subtitle" name="BO_subtitle">Live <a href='https://pskreporter.info/'>Pskreporter</a> statistics for FT8 spots on all bands between Home and DX</div>
<div class="detail" id="controls" name="controls"></div>
<div class="detail" id="detail" name="detail"></div>
<div class="bandblock" id="bandblock"></div>
<div class="creditsblock" id="credits" name="credits">
  <div>
    Javascript & HTML developed by Alan Robinson:<br>
    <a href='https://www.instagram.com/g1ojs_alan/'>G1OJS_alan@instagram.com</a><br>
    <a href="mailto:G1OJS@yahoo.com">G1OJS@yahoo.com</a><br><a href='https://g1ojs.github.io/'>G1OJS Ham Radio @GitHub</a><br>
  </div><div>
    Thanks to:<br>
    Philip Gladstone - N1DQ for https://pskreporter.info/<br>
    Tom Stanton - M0LTE for mqtt.pskreporter.info, the MQTT feed for this app<br>
    <a href='https://www.unpkg.com/browse/mqtt@5.10.1/README.md'>www.unpkg.com</a> for the cdn MQTT library used here <a href='https://www.unpkg.com/browse/mqtt@5.10.1/LICENSE.md'>MIT license</a>
  </div><div>
    BandOpticon License: <a href='https://github.com/G1OJS/BandOpticon/blob/main/LICENSE'>MIT license</a><br>
    BandOpticon GitHub: <a href='https://github.com/G1OJS/BandOpticon/'>G1OJS/BandOpticon</a><br>
  </div>
</div>
</div></body>

<!--Get the library for MQTT functions -->
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<script>

 // initialisation and functions to load and save configuration
 
  const Bands=["160m","80m","60m","40m","30m","20m","17m","15m","12m","10m","6m","4m","2m","70cm","23cm"];
  let refreshSeconds=2;
  let purgeMinutes=5;
  let detailWanted="Layout";
  let spots=[];
  let tWrite=0; // time of last write set to 1 Jan 1970 so screen will update asap
  let tStart=Date.now(); // software start
  const defaultSquares=["IO","JO01","JO02","JO03","JO04"]
  let Squares=[];
  let myCall="G1OJS";
  // count the spot processing stats just for fun:
  let spotsAdded=0;
  let spotsPurged=0;
  
  function saveConfig(){
      console.log("Saving config:");
      localStorage.setItem('Squares', JSON.stringify(Squares));
      console.log("Saved Squares: "+Squares);
      localStorage.setItem('myCall', myCall);
      console.log("Saved myCall: "+myCall);
      localStorage.setItem('purgeMinutes', purgeMinutes);
      console.log("Saved purgeMinutes: "+purgeMinutes);
  }
  
  function loadConfig(){
    if(localStorage.getItem('Squares')){
      try {
        Squares=JSON.parse(localStorage.getItem('Squares'));
        console.log("Loaded local config. Squares= "+Squares);
      }
      catch(err) {
        console.log("Local storage result for squares: "+Squares);
        localStorage.removeItem('Squares');
        Squares=defaultSquares;
        localStorage.setItem('Squares', JSON.stringify(Squares));
        console.log("Error loading local config data: defaults applied and local copy replaced");
        }
    } else {
      Squares=defaultSquares;
      console.log("No local config data found: defaults applied.");
      saveConfig();
    }
    if(localStorage.getItem('myCall')){
      myCall=localStorage.getItem('myCall');
    } else {
      myCall="G1OJS";
      saveConfig();
    }
    if(localStorage.getItem('purgeMinutes')){
      purgeMinutes=localStorage.getItem('purgeMinutes');
    } else {
      purgeMinutes=5;
      saveConfig();
    }
  }
  
  loadConfig();
  updateDetails();
  updateControls();
  
  // done with initialisation now
  
  // function to write HTML to the Details box
  function updateDetails(newWant){
  // this argument part is clunky 
  // (pass nothing for no change, -1 for Layout, >=0 for band detail (iBand))
    if(!(typeof newWant==='undefined')) {
       if(newWant>=0) {detailWanted=newWant} else {detailWanted="Layout"}
    };
    if(detailWanted=="Layout"){
      detail.innerHTML="<div>Band box layout:<br><strong>Band</strong><br> \
         Spots: number of spots "+
         "<span class='interzone'> Home &#8680 Home /</span>"+
         "<span class='outgoing'> Home &#8680 DX /</span>"+
         "<span class='incoming'> DX &#8680 Home</span><br>"+
         "<span class='transmit'>Tx Calls: number of unique calls in 'Home' received by anyone</span><br>"+
         "<span class='receive'>Rx Calls: number of unique calls in 'Home' receiving anyone</span></div>"
    } else {
      writeBandActiveCallsInDetails(detailWanted);
    }
  }

  // function to write HTML to the Controls box
  function updateControls(){
    var now = new Date;
    var utc_timestamp = now.getUTCDate()+"/"+now.getUTCMonth()+"/"+now.getUTCFullYear()+" "
       +("0"+now.getUTCHours()).substr(-2)+":"
       +("0"+now.getUTCMinutes()).substr(-2)+":"
       +("0"+now.getUTCSeconds()).substr(-2)+" UTC";
    var runningmins=Math.trunc(((now-tStart)/1000) / 60);
    var sqs=Squares.join(';')+" <a href='#controls' onclick='editSquares();'>edit</a>";
    controls.innerHTML="<div><strong>"+utc_timestamp+"</strong> (running for "+runningmins+" minutes)"+
       "<br>Home = Squares "+sqs+"<br>"+
       "My callsign = "+myCall+" <a href='#controls' onclick='editMyCall();'>edit</a><br>"+
       spots.length+" spots in database ("+spotsAdded+" added, "+spotsPurged+" purged). Spots purged when older than "+purgeMinutes+" minutes <a href='#controls' onclick='editPurgeMins();'>edit</a><br>"
  }

  // needs validation code
  function editMyCall(){
    var resp=prompt("Enter your callsign",myCall);
    myCall=resp;
    localStorage.setItem('myCall',myCall);
  }
  
  // needs validation code
  function editPurgeMins(){
    var resp=prompt("Enter minutes for spot expiry",purgeMinutes);
    purgeMinutes=resp;
    localStorage.setItem('purgeMinutes',purgeMinutes);
  }
  
  // function to allow the user to edit the home squares list
  function editSquares(){
    var resp=prompt("Enter Squares",Squares);
      var test=resp.split(','); // need to convert resp string to array
      squaresValid=true;
      for (let i=0;i<test.length;i++){
        if(validSquare(test[i])==0) squaresValid=false;
      }
      if(squaresValid){
      Squares=test;
      console.log("Squares updated to: "+Squares);
      saveConfig();
      updateControls();
      spots=[]; //home squares has changed so clear all spots
      tWrite=0; //forces a screen update on next message
    } else {
      alert("Please enter a comma-separated list of valid squares.\n\nYou entered "+test);
    }
  }

// Dynamically write the HTML needed to complete the layout (band boxes)
  var toAdd = document.createDocumentFragment();
  for(var i=0; i < Bands.length; i++){
    var newDiv = document.createElement('div');
    newDiv.id = Bands[i];     
    newDiv.innerHTML="<strong>"+Bands[i]+"</strong> \
      <a href='#controls' onclick='updateDetails("+i+");'> details</a><br> \
      <output id='"+Bands[i]+"spots'></output><br> \
      <output id='"+Bands[i]+"calls'></output>";
    toAdd.appendChild(newDiv);
  }
  document.getElementById('bandblock').appendChild(toAdd);

  // Connect to Pskreporter and subscribe on connect
  const client=mqtt.connect("wss://mqtt.pskreporter.info:1886");
  client.onSuccess=client.subscribe('pskr/filter/v2/+/FT8/+/+/+/+/+/#');
  client.on("message", (filter,message) => {onMessage(message.toString());}  );

  function onMessage(message){    
    if ( (Date.now()-tWrite)/1000 > refreshSeconds ){
    	tWrite=Date.now();
      purgeSpots();
      writeBandSpotStats();
      writeBandActiveCallStats();
      updateDetails();
      updateControls();
    }
    //ignore nessages for bands we aren't set up to watch
    b=getVal("b",message); 
    if(!Bands.includes(b)) {return;}
    //if either end of the spot is in home squares, add this spot
    sl=getVal("sl",message);
    if(SquareInHome(sl)){addSpot(message); return;}
    rl=getVal("rl",message);
    if(SquareInHome(rl)){addSpot(message);}
  }
  
  function purgeSpots(){
    // get rid of spots older than purgeMinutes
    var del=[];
    for (let iSpot=0; iSpot < spots.length; iSpot++) {
      var spot=spots[iSpot];
      var tSpot=spot[1];
      if(((Date.now()-tSpot)/1000)/60 > purgeMinutes) {del.push(iSpot)}
    }
    for(let iDel=0; iDel <del.length;iDel++) {spots.splice(del[iDel],1)}
    spotsPurged+=del.length;
  }
  
  function addSpot(message){
    band=getVal("b",message);
    senderCall=getVal("sc",message);
    receiverCall=getVal("rc",message);
    senderSq=getVal("sl",message).toUpperCase();
    receiverSq=getVal("rl",message).toUpperCase();
    tSpot=Date.now(); // working with time spot received not time spot generated
    spots.push([band,tSpot,senderCall,receiverCall,senderSq,receiverSq]);
    spotsAdded+=1;
  }
  
  function writeBandSpotStats(){
    // create 2D bandstats array before we loop across spots & count 
    // spots vs band and direction
    var bandStats = [];
    for(let i = 0; i < Bands.length; i++) {
        bandStats[i]=[];
        bandStats[i][0]=0;
        bandStats[i][1]=0;
        bandStats[i][2]=0;
    }
    for(let iSpot=0; iSpot < spots.length; iSpot++) {
      var spot=spots[iSpot];
      var dircode=0;    // dircode will be 0=H->H, 1=DX->H, 2=H->DX, 3=DX-DX
      if(!SquareInHome(spots[iSpot][4])) {dircode+=1};
      if(!SquareInHome(spots[iSpot][5])) {dircode+=2};
      let iBand=Bands.indexOf(spot[0]);
      // DX->DX should never happen as we discarded it above
      if(dircode>2 || iBand==-1){
         console.log("Bad spot "+spot); 
      } else {
         bandStats[iBand][dircode]+=1;
      }
    }
    // done counting so now write results to HTML
    for (let i=0; i < Bands.length; i++) {
      var snum=bandStats[i];
      document.getElementById(Bands[i]+"spots").innerHTML=
        "Spots "+snum[0]
        +"/<span class='outgoing'>"+snum[2]
        +"</span>/<span class='incoming'>"+snum[1]
        +"</span>";
    }
  }
  
   function writeBandActiveCallStats(){
  //spots array 0=band,1=tSpot,2=senderCall,3=receiverCall,4=senderSq,5=receiverSq
     for (let iBand=0; iBand<Bands.length; iBand++){
       //note - we use sets here as an easy way of counting unique calls
       var active_tx=new Set;
       var active_rx=new Set;
       for (let iSpot=1; iSpot < spots.length; iSpot++) {
         var spot=spots[iSpot];
         if(spot[0]==Bands[iBand]){
           if(SquareInHome(spot[4])) {active_tx.add(spot[2])};
           if(SquareInHome(spot[5])) {active_rx.add(spot[3])};
         }
       }
       document.getElementById(Bands[iBand]+"calls").innerHTML=
         "<span class='transmit'>Tx Calls "+active_tx.size+"</span><br>"+
         "<span class='receive'>"+"Rx Calls "+active_rx.size+"</span>";
     }
   }
    
  function writeBandActiveCallsInDetails(iBand){
    const showSquaresWithCalls=false;
    var active_tx=new Set;
    var active_rx=new Set;
    var Sqs_reached=new Set;
    var Sqs_spotted=new Set;
    var Sqs_reachedByMe=new Set;
    var Sqs_spottedByMe=new Set;
    for (let iSpot=1; iSpot < spots.length; iSpot++) {
      var spot=spots[iSpot];
      //spots array 0=band,1=tSpot,2=senderCall,3=receiverCall,4=senderSq,5=receiverSq
      if(spot[0]==Bands[iBand]){
        if(SquareInHome(spot[4])) {
           txcall=spot[2];
           if(txcall==myCall){Sqs_reachedByMe.add(spot[5].substr(0,4));}
           if(showSquaresWithCalls) {txcall=txcall+"-"+spot[4].substr(0,4)}
           active_tx.add(txcall);
           Sqs_reached.add(spot[5].substr(0,4));
        }
        if(SquareInHome(spot[5])) {
           rxcall=spot[3];
           if(rxcall==myCall){Sqs_spottedByMe.add(spot[4].substr(0,4));}
           if(showSquaresWithCalls) {rxcall=rxcall+"-"+spot[5].substr(0,4)}
           active_rx.add(rxcall);
           Sqs_spotted.add(spot[4].substr(0,4));
        }
      }
    }
    
    // if any of the lists of squares is very long, let's display them at level 2 instead of level 4
    const ml=20;
    var lvl=4;
    if(Sqs_reached.size>ml || Sqs_reachedByMe.size>ml 
       || Sqs_spotted.size>ml || Sqs_spottedByMe.size>ml) {lvl=2}
   
    // done analysing, now write the HTML in the details div
    // together with button to revert to band layout reminder
    // need a bit of processing here as it's a big wedge of text to generate
    var topHTML="<div>"+ "<strong>"+Bands[iBand]+" details</strong> (<a href='#controls' onclick='updateDetails(-1);'>close</a>)<br>";
    
    var txHTML="<p class='transmit'><strong>Tx calls:</strong> "
    txHTML+=Array.from(active_tx).toSorted().join(' ');
    txHTML+="<br><strong>Squares reached:</strong> "+SquaresArrayFromSquaresSet(Sqs_reached,lvl).join(' ');
    txHTML+="<br><strong>Squares reached by me:</strong> "+SquaresArrayFromSquaresSet(Sqs_reachedByMe,lvl).join(' ');
    txHTML+="<br></p>"
    
    var rxHTML="<p class='receive'><strong>Rx calls:</strong> "
    rxHTML+=Array.from(active_rx).toSorted().join(' ')
    rxHTML+="<br><strong>Squares spotted:</strong> "+SquaresArrayFromSquaresSet(Sqs_spotted,lvl).join(' ');
    rxHTML+="<br><strong>Squares spotted by me:</strong> "+SquaresArrayFromSquaresSet(Sqs_spottedByMe,lvl).join(' ');
    rxHTML+="<br></p>"
       
    detail.innerHTML=topHTML+txHTML+rxHTML+"</div>";
  }
  
  function SquaresArrayFromSquaresSet(sqSet,lvl){
    // take the unique-valued squares Set at level 4 (or more)
    // and produce a sorted squares Array at level=lvl
    var sqArr=Array.from(sqSet).toSorted();
    var sqSet2=new Set;
    // going one by one because we need to apply substr to each element
    for (let i=0;i<sqArr.length;i++){sqSet2.add(sqArr[i].substr(0,lvl))};
    return Array.from(sqSet2)
  }

  function validSquare(locator){
    // if a valid level 2,4,6,8 or 10 square, return the level else return 0
    if(RegExp("^[A-R]{2}$").test(locator)) {return 2};
    if(RegExp("^[A-R]{2}[0-9]{2}$").test(locator)) {return 4};
    if(RegExp("^[A-R]{2}[0-9]{2}[A-X]{2}$").test(locator)) {return 6};
    if(RegExp("^[A-R]{2}[0-9]{2}[A-X]{2}[0-9]{2}$").test(locator)) {return 8};
    if(RegExp("^[A-R]{2}[0-9]{2}[A-X]{2}[0-9]{2}[A-X]{2}$").test(locator)) {return 10};
    return 0;
  }

  function SquareInHome(sq){
    // return true if the level 2,4 or 6 square sq is in the home squares array
    return (Squares.includes(sq.substr(0,2)) || Squares.includes(sq.substr(0,4)) || Squares.includes(sq.substr(0,6)));
  }
  
  function getVal(key,message){
    // parse the MQTT message to get the part we want (key)
    var iVal=message.indexOf('"'+key+'":');
    var iColon=message.indexOf(':',iVal);
    var iComma=message.indexOf(",",iColon);
    var val=message.slice(iColon+1,iComma).replace(/"/g, '');
    return val;
  }

</script>


</html>
