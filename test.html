<!-- To do:
  - check detail code for "only by myCall" detail
  - highlighting of myCall when entities are not calls - how to highlight s
  - highlighting of squares common to myCall and others, and list "only by myCall"
  - define functions to make flow aparrent in writeStats
  - add back the H2H/H2DX/DX2H stats
  - Look at element margins to show nicer borders around things to group better
  - validation code for purge minutes (and callsign?)
  - check consistency of let, var, continuation + and \ and <br>
-->

<html>
<head><style>

:root {background-color: #91FCFE; color:black;text-align: left; font-size: 1.3vmax; }
div {margin: 0px;  padding: 0px;}
#title {text-align: center; font-size: 5rem;}
#subtitle {text-align: center; font-size: 1.5rem; margin-bottom:10px;}
#legend > div {background-color: white; margin: 1px;  padding: 1px;  }
.controls {display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: auto;}
.controls > div {background-color: white; margin: 1px;  padding: 1px;}

.detailsTop > div {background-color: white; margin: 1px;  padding: 1px; font-size: 0.8rem; }
.detailsGrid {display: grid; grid-template-columns: 1fr 4fr; grid-template-rows: auto;}
.detailsGrid > div {background-color: white; margin: 1px;  padding: 1px; font-size: 0.8rem; }
.bandsGrid {display: grid; grid-template-columns: auto auto auto auto auto;}
.bandsGrid > div {background-color: white; margin: 1px;  padding: 1px; }
.creditsGrid {color:black; font-size: 0.7rem; display: grid; grid-template-columns: auto auto auto;}
.transmit {color:red;}
.receive {color:green; }
.interzone {color:blue; }
.outgoing {color:Fuchsia; }
.incoming {color:olive;}
a:link {color: blue;}
a:visited {color: blue;}
</style>
</head>

<body><div>
<div id="title">BandOpticon</div>
<div id="subtitle">Live <a href='https://pskreporter.info/'>Pskreporter</a> statistics for FT8 spots on all bands between Home and DX</div>

 <div class="controls" name="controls">
  <div id="controls_l"></div>
  <div id="controls_r">
   What to show above band summary tiles? <br>
   - <a href='#controls' onclick='updateDetails(&quot;Layout&quot);'>Band tile legend</a><br>
   - <a href='#controls' onclick='updateDetails(&quot;CallsAndSquares&quot);'>Activity Detail</a><br>
   - <a href='#controls' onclick='updateDetails(&quot;Nothing&quot);'>Nothing</a><br>
   Click 'details' in band tiles below to set the band
   <br><a href='#controls' onclick='startRecording();'>Experimental stats recorder</a> 
  </div>
 </div>


<div id="legend"></div>

</div>

<div class="detailsTop" id="detailsTop"></div>
<div class="detailsGrid" id="detailsGrid"></div>

<div class="bandsGrid" id="bandsGrid" style="border:solid;"></div>
<div class="creditsGrid">
  <div>
    Javascript & HTML developed by Alan Robinson:<br>
    <a href='https://www.qrz.com/db/G1OJS'><G1OJS @QRZ.com</a>
    <a href='https://www.instagram.com/g1ojs_alan/'>G1OJS_alan@instagram.com</a><br>
    <a href='https://g1ojs.github.io/'>G1OJS Ham Radio @GitHub</a><br>
    <a href="mailto:G1OJS@yahoo.com">G1OJS@yahoo.com</a><br>
  </div>
  <div>
    Thanks to:<br>
    Philip Gladstone - N1DQ for https://pskreporter.info/<br>
    Tom Stanton - M0LTE for mqtt.pskreporter.info, the MQTT feed for this app<br>
    <a href='https://www.unpkg.com/browse/mqtt@5.10.1/README.md'>www.unpkg.com</a> for the cdn MQTT library used here <a href='https://www.unpkg.com/browse/mqtt@5.10.1/LICENSE.md'>MIT license</a>
  </div>
  <div>
    BandOpticon License: <a href='https://github.com/G1OJS/BandOpticon/blob/main/LICENSE'>MIT license</a><br>
    BandOpticon GitHub: <a href='https://github.com/G1OJS/BandOpticon/'>G1OJS/BandOpticon</a><br>
    <a href="https://hits.seeyoufarm.com"><img src="https://hits.seeyoufarm.com/api/count/incr/badge.svg?url=https%3A%2F%2Fgithub.com%2Fgjbae1212%2Fhit-counter"/></a>                        
  </div>
</div>
</div></body>

<!--Get the library for MQTT functions -->
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

<script>

 // initialisation and functions to load and save configuration
 
  const Bands=["160m","80m","60m","40m","30m","20m","17m","15m","12m","10m","6m","4m","2m","70cm","23cm"];
  let refreshSeconds=1;
  let purgeMinutes=5;
  let detailsWanted="Layout";
  let iDetailsBandIndex=0;
  let spotsArr=[];
  let tWrite=0; // time of last write set to 1 Jan 1970 so screen will update asap
  let tStart=Date.now(); // software start
  const defaultSquares=["IO","JO01","JO02","JO03","JO04"]
  let Squares=[];
  var squaresDisplayLevel=4;
  let myCall="G1OJS";
  // count the spot processing stats just for fun:
  let spotsAdded=0;
  let spotsPurged=0;
  const HLOn="<b><u>";
  const HLOff="</u></b>"; 
  const SpotsLegend="<span class='interzone'> Home &#8680 Home /</span>"
         + "<span class='outgoing'> Home &#8680 DX /</span>"
         + "<span class='incoming'> DX &#8680 Home</span>"
  let recordData=false;
  let newWindow=null;
  let twriteData=0;
  let dataWriteInterval=15;
  var entity="Call";
  var groupHomeCalls=false;
  
  function get_utc_timestamp(t){ 
    return t.getUTCDate()+"/"+(t.getUTCMonth()+1)+"/"+t.getUTCFullYear()+" "
       +("0"+t.getUTCHours()).substr(-2)+":"
       +("0"+t.getUTCMinutes()).substr(-2)+":"
       +("0"+t.getUTCSeconds()).substr(-2)+" UTC";
  }

  function startRecording(){
    let params = `scrollbars=yes,resizable=yes,scrollbars=yes,width=500,height=200,left=0,top=0`;
    newWindow = open('https://g1ojs.github.io/BandOpticon/blank.html', '_blank',params);
    newWindow.onload = function() {
  	let html = `<div style="font-size:30px">BandOpticon is recording data</div>`;
  	newWindow.document.body.insertAdjacentHTML('afterbegin', html);
	  recordData=true
	  console.log(html);
    };
  }
  
  function writeData(data){
    if( (Date.now()-twriteData)/1000 > dataWriteInterval) {
      twriteData=Date.now();
      t=new Date;
      var data_html="<br>"+get_utc_timestamp(t)+","+data;
      newWindow.document.body.insertAdjacentHTML('beforebegin',data_html);
      console.log("Data window write:  "+data_html);
    }
  }
	
  function saveConfig(){
      console.log("Saving config:");
      localStorage.setItem('Squares', JSON.stringify(Squares));
      console.log("Saved Squares: "+Squares);
      localStorage.setItem('myCall', myCall);
      console.log("Saved myCall: "+myCall);
      localStorage.setItem('purgeMinutes', purgeMinutes);
      console.log("Saved purgeMinutes: "+purgeMinutes);
  }
  
  function loadConfig(){
    if(localStorage.getItem('Squares')){
      try {
        Squares=JSON.parse(localStorage.getItem('Squares'));
        console.log("Loaded local config. Squares= "+Squares);
      }
      catch(err) {
        console.log("Local storage result for squares: "+Squares);
        localStorage.removeItem('Squares');
        Squares=defaultSquares;
        localStorage.setItem('Squares', JSON.stringify(Squares));
        console.log("Error loading local config data: defaults applied and local copy replaced");
        }
    } else {
      Squares=defaultSquares;
      console.log("No local config data found: defaults applied.");
      saveConfig();
    }
    if(localStorage.getItem('myCall')){
      myCall=localStorage.getItem('myCall');
    } else {
      myCall="G1OJS";
      saveConfig();
    }
    if(localStorage.getItem('purgeMinutes')){
      purgeMinutes=localStorage.getItem('purgeMinutes');
    } else {
      purgeMinutes=5;
      saveConfig();
    }
  }
  
  loadConfig();
  updateDetails();
  updateControls();
  
  // done with initialisation now
  
  // function to write HTML to the details grid
  function updateDetails(newWant,iDB){
    if(!(typeof newWant==='undefined')) {
      detailsWanted=newWant;console.log("New details pane content requested: ",newWant,iDB);
      console.log("details vars are: ",detailsWanted,iDetailsBandIndex);
    }
    if(!(typeof iDB==='undefined')) {
      iDetailsBandIndex=iDB;console.log("New details pane content requested: ",newWant,iDB);
      // user clicked on "details" in a band tile whilst legend or 'nothing' showing
      // user might not think to set the content type, so default it to calls and squares
      if(detailsWanted=="Layout" || detailsWanted=="Nothing" ){detailsWanted="CallsAndSquares"}
      console.log("details vars are: ",detailsWanted,iDetailsBandIndex);
    }
    
    if(detailsWanted=="Layout"){
      legend.innerHTML="<div>Band tile legend:<br><strong>Band</strong><br> \
         Spots: number of spots "+SpotsLegend+"<br>"+
         "<span class='transmit'>Tx Calls: number of unique calls in 'Home' received by anyone</span><br>"+
         "<span class='receive'>Rx Calls: number of unique calls in 'Home' receiving anyone</span></div>";
      detailsGrid.innerHTML="";
      detailsTop.innerHTML="";
    } 
    
    if(detailsWanted=="Nothing") {
      legend.innerHTML="";
      detailsGrid.innerHTML="";
      detailsTop.innerHTML="";
    }
  }
   
  // function to write HTML to the Controls box
  function updateControls(){
    var now = new Date;
    var utc_timestamp=get_utc_timestamp(now);
    var runningmins=Math.trunc(((now-tStart)/1000) / 60);
    var sqs=Squares.join(',')+" <a class='textAnchorButton' href='#controls' onclick='editSquares();'>edit</a>";
    controls_l.innerHTML="<div><strong>"+utc_timestamp+"</strong>"
       +"<br> - running for "+runningmins+" minutes"
       +"<br>Home = "+sqs+"<br>"
       +"My call = "+myCall+" <a class='textAnchorButton' href='#controls' onclick='editMyCall();'>edit</a><br>"
       +spotsArr.length+" spots in database"
       +"<br>"+spotsAdded+" added, "+spotsPurged+" purged<br>"
       +" Spots purged if older than "+purgeMinutes+" mins <a class='textAnchorButton' href='#controls' onclick='editPurgeMins();'>edit</a><br>"
  }

  // needs validation code
  function editMyCall(){
    var resp=prompt("Enter your callsign",myCall);
    myCall=resp;
    localStorage.setItem('myCall',myCall);
  }
  
  // needs validation code
  function editPurgeMins(){
    var resp=prompt("Enter minutes for spot expiry",purgeMinutes);
    purgeMinutes=resp;
    localStorage.setItem('purgeMinutes',purgeMinutes);
  }
  
  // function to allow the user to edit the home squares list
  function editSquares(){
    var resp=prompt("Enter Squares",Squares);
      var test=resp.split(','); // need to convert resp string to array
      squaresValid=true;
      for (let i=0;i<test.length;i++){
        if(validSquare(test[i])==0) squaresValid=false;
      }
      if(squaresValid){
      Squares=test;
      console.log("Squares updated to: "+Squares);
      saveConfig();
      updateControls();
      spots=[]; //home squares has changed so clear all spots
      tWrite=0; //forces a screen update on next message
    } else {
      alert("Please enter a comma-separated list of valid squares.\n\nYou entered "+test);
    }
  }

// Write the <div>s for each band summary tile in the bandsGrid area
  var toAdd = document.createDocumentFragment();
  for(var i=0; i < Bands.length; i++){
    var newDiv = document.createElement('div');
    newDiv.id = Bands[i];     
    newDiv.innerHTML="<strong>"+Bands[i]+"</strong> \
      <a class='textAnchorButton' href='#controls' onclick='updateDetails("+undefined+","+i+");'> \
         details</a><br> \
      <output id='"+Bands[i]+"spots'></output><br> \
      <output id='"+Bands[i]+"calls'></output>";
    toAdd.appendChild(newDiv);
  }
  document.getElementById('bandsGrid').appendChild(toAdd);

  // Connect to Pskreporter and subscribe on connect
  const client=mqtt.connect("wss://mqtt.pskreporter.info:1886");
  client.onSuccess=client.subscribe('pskr/filter/v2/+/FT8/+/+/+/+/+/#');
  client.on("message", (filter,message) => {onMessage(message.toString());}  );

  function onMessage(message){    
    if ( (Date.now()-tWrite)/1000 > refreshSeconds ){
      tWrite=Date.now();
    //  purgeSpots();
      updateControls();
      writeStats();
      console.log("Analysis took "+(Date.now()-tWrite).toString()+"mS");
    }
    //ignore nessages for bands we aren't set up to watch
    b=getVal("b",message); 
    if(!Bands.includes(b)) {return;}
    //if either end of the spot is in home squares, add this spot
    sl=getVal("sl",message);
    if(squareIsInHome(sl)){addSpot(message); return;}
    rl=getVal("rl",message);
    if(squareIsInHome(rl)){addSpot(message);}
  }
  
  function purgeSpots(){
    // get rid of spots older than purgeMinutes
    var del=[];
    for (let iSpot=0; iSpot < spotsArr.length; iSpot++) {
      var spot=spotsArr[iSpot];
      var tSpot=spotArr[1];
      if(((Date.now()-tSpot)/1000)/60 > purgeMinutes) {del.push(iSpot)}
    }
    for(let iDel=0; iDel <del.length;iDel++) {spotsArr.splice(del[iDel],1)}
    spotsPurged+=del.length;
  }
  
  function addSpot(message){
    band=getVal("b",message);
    senderCall=getVal("sc",message);
    receiverCall=getVal("rc",message);
    senderSq=getVal("sl",message).toUpperCase();
    receiverSq=getVal("rl",message).toUpperCase();
    tSpot=Date.now(); // working with time spot received not time spot generated
    spotsArr.push([band,tSpot,senderCall,receiverCall,senderSq,receiverSq]);
    spotsAdded+=1;
  }
  
  function writeStats(){

  //spots array 0=band,1=tSpot,2=senderCall,3=receiverCall,4=senderSq,5=receiverSq
     for (let iBand=0; iBand<Bands.length; iBand++){
       var callsTransmitting=new Set;
       var callsReceiving=new Set;
       for (let iSpot=1; iSpot < spotsArr.length; iSpot++) {
         var spot=spotsArr[iSpot];
         if(spot[0]==Bands[iBand]){
           if(squareIsInHome(spot[4])) {callsTransmitting.add(spot[2])};
           if(squareIsInHome(spot[5])) {callsReceiving.add(spot[3])};
         }
       }
       document.getElementById(Bands[iBand]+"calls").innerHTML=
         "<span class='transmit'>Tx Calls "+callsTransmitting.size+"</span><br>"+
         "<span class='receive'>"+"Rx Calls "+callsReceiving.size+"</span>";

      if(iBand==iDetailsBandIndex){
      
        detailsTop.innerHTML="<div><strong>"+Bands[iDetailsBandIndex]+" Band Activity Details</strong>" 
          +"<br>Total "+document.getElementById(Bands[iDetailsBandIndex]+"spots").innerHTML+SpotsLegend+"<br>"
          +"Entities common to "+myCall+" and the other calls are "+HLOn+"highlighted"+HLOff+"</div>";
      
        detailsGrid.innerHTML="<div><strong>Home <span class='transmit'>Tx Calls</span> and <span class='receive'>Rx Calls</span></strong></br>"
        +"<a class='textAnchorButton' href='#controls' onclick='groupHomeCalls=false;tWrite=0;return;'>List each call</a>"
        +" <a class='textAnchorButton' href='#controls' onclick='groupHomeCalls=true;tWrite=0;return;'>Group into Tx & Rx</a></div>"
        +"<div><strong>Entities spotting Home Tx Calls / spotted by Home RX Calls</strong><br>"
        +"<a class='textAnchorButton' href='#controls' onclick='entity=&quot;Call&quot;;tWrite=0;return;'>Show callsigns </a>"
        +"<br><a class='textAnchorButton' href='#controls' onclick='entity=&quot;Square&quot;;squaresDisplayLevel=2;tWrite=0;return;'>Show level 2 squares</a>"
        +" <a class='textAnchorButton' href='#controls' onclick='entity=&quot;Square&quot;;squaresDisplayLevel=4;tWrite=0;return;'>Show level 4 squares</a>"
        +" <a class='textAnchorButton' href='#controls' onclick='entity=&quot;Square&quot;;squaresDisplayLevel=6;tWrite=0;return;'>Show level 6 squares</a></div>"
 

        let callsTransmittingArr=Array.from(callsTransmitting).toSorted();
        var entitiesReachedInHome=new Set;
        var entitiesReachedInOther=new Set;
        // transmitter loop
        for (let iCall=0;iCall<callsTransmittingArr.length;iCall++){
          var txCall=callsTransmittingArr[iCall];
          //spots array 0=band,1=tSpot,2=senderCall,3=receiverCall,4=senderSq,5=receiverSq
          for(i=0;i<spotsArr.length;i++){
            if(spotsArr[i][2]==txCall){
               let reachedEntity="";
               if(entity=="Call"){reachedEntity=spotsArr[i][3]} else {reachedEntity=spotsArr[i][5].substr(0,squaresDisplayLevel)}
               if(squareIsInHome(spotsArr[i][5])){entitiesReachedInHome.add(reachedEntity)} else {entitiesReachedInOther.add(reachedEntity)} 
            }
          }
          if(!groupHomeCalls){ 
            detailsGrid.innerHTML+="<div class='transmit'>"+HL(txCall,myCall)+"</div><div><span class='interzone'>"+Array.from(entitiesReachedInHome).toSorted().map(item => HL(item,myCall)).join(', ')+"</span> <span class='outgoing'>"+Array.from(entitiesReachedInOther).toSorted().join(', ')+"</span><div>";
            entitiesReachedInHome.clear();
            entitiesReachedInOther.clear();
          }
        }
        if(groupHomeCalls){ 
          detailsGrid.innerHTML+="<div class='transmit'>"+callsTransmittingArr+"</div><div><span class='interzone'>"+Array.from(entitiesReachedInHome).toSorted().map(item => HL(item,myCall)).join(', ')+"</span> <span class='outgoing'>"+Array.from(entitiesReachedInOther).toSorted().join(', ')+"</span><div>";
        }
        // receiver loop
        let callsReceivingArr=Array.from(callsReceiving).toSorted();
        var entitiesSpottedInHome=new Set;
        var entitiesSpottedInOther=new Set;
        for (let iCall=0;iCall<callsReceivingArr.length;iCall++){
          var rxCall=callsReceivingArr[iCall];

          //spots array 0=band,1=tSpot,2=senderCall,3=receiverCall,4=senderSq,5=receiverSq
          for(i=0;i<spotsArr.length;i++){
            if(spotsArr[i][3]==rxCall){
               let spottedEntity="";
               if(entity=="Call"){spottedEntity=spotsArr[i][2]} else {spottedEntity=spotsArr[i][4].substr(0,squaresDisplayLevel)}
               if(squareIsInHome(spotsArr[i][4])){entitiesSpottedInHome.add(spottedEntity)} else {entitiesSpottedInOther.add(spottedEntity)} 
            }
          }
          if(!groupHomeCalls){
            detailsGrid.innerHTML+="<div class='receive'>"+HL(rxCall,myCall)+"</div><div><span class='interzone'>"+Array.from(entitiesSpottedInHome).toSorted().map(item => HL(item,myCall)).join(', ')+"</span> <span class='incoming'>"+Array.from(entitiesSpottedInOther).toSorted().join(', ')+"</span><div>";
            entitiesSpottedInHome.clear();
            entitiesSpottedInOther.clear();
          }
        }
        if(groupHomeCalls){
          detailsGrid.innerHTML+="<div class='receive'>"+callsReceivingArr+"</div><div><span class='interzone'>"+Array.from(entitiesSpottedInHome).toSorted().map(item => HL(item,myCall)).join(', ')+"</span> <span class='incoming'>"+Array.from(entitiesSpottedInOther).toSorted().join(', ')+"</span><div>";
        }
      }
    }
  }

           /*         
   
 

          let entitiesReachedInHomeArr=Array.from(entitiesReachedInHome).toSorted().map(item => {if(item.split(",")[0]==txCall) {return item.split(",")[1]} else {return ""}});
          console.log(entitiesReachedInHomeArr);
          let cellTRH="<span class='interzone'>"+entitiesReachedInHomeArr.map(item => {if(entitiesReachedByMe.has(item)){return HLOn+item+HLOff} else {return item}}).join(' ')+"</span> ";
          let entitiesReachedInOtherArr=Array.from(entitiesReachedInOther).toSorted().map(item => {if(item.split(",")[0]==txCall) {return item.split(",")[1]} else {return ""}});
        cellTRH+="<span class='outgoing'>"+entitiesReachedInOtherArr.map(item => {if(entitiesReachedByMe.has(item)){return HLOn+item+HLOff} else {return item;}}).join(' ')+"</span>";
          detailsGrid.innerHTML+="<div class='transmit'>"+cellTLH+"</div><div>"+cellTRH+"</div>";
        }
      }
*/
   
  function HL(item,pattern){
      if(item==pattern || pattern==true){return HLOn+item+HLOff} else {return item}
  }
  
  function cycleSDL(){
     squaresDisplayLevel+=2;
     if(squaresDisplayLevel>6){squaresDisplayLevel=2}
     document.getElementById('SDL').value=squaresDisplayLevel;
     tWrite=0; //forces a screen update on next message
  }

  function validSquare(locator){
    // if a valid level 2,4,6,8 or 10 square, return the level else return 0
    if(RegExp("^[A-R]{2}$").test(locator)) {return 2};
    if(RegExp("^[A-R]{2}[0-9]{2}$").test(locator)) {return 4};
    if(RegExp("^[A-R]{2}[0-9]{2}[A-X]{2}$").test(locator)) {return 6};
    if(RegExp("^[A-R]{2}[0-9]{2}[A-X]{2}[0-9]{2}$").test(locator)) {return 8};
    if(RegExp("^[A-R]{2}[0-9]{2}[A-X]{2}[0-9]{2}[A-X]{2}$").test(locator)) {return 10};
    return 0;
  }

  function squareIsInHome(sq){
    // return true if the level 2,4 or 6 square sq is in the home squares array
    return (Squares.includes(sq.substr(0,2)) || Squares.includes(sq.substr(0,4)) || Squares.includes(sq.substr(0,6)));
  }
  
  function getVal(key,message){
    // parse the MQTT message to get the part we want (key)
    var iVal=message.indexOf('"'+key+'":');
    var iColon=message.indexOf(':',iVal);
    var iComma=message.indexOf(",",iColon);
    var val=message.slice(iColon+1,iComma).replace(/"/g, '');
    return val;
  }

</script>


</html>
